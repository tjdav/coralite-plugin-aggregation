<template id="coralite-pagination">
  <nav aria-label="{{ ariaLabel }}">
    <ul class="pagination">
      {{ paginationLinks }}
    </ul>
  </nav>
</template>

<script type="module">
  import { defineComponent } from 'coralite'

  export default defineComponent({
    tokens: {
      ariaLabel(context) {
        return context['aria-label'] || 'Page navigation'
      },
      /**
       * Generates HTML pagination links based on the provided context.
       *
       * @param {Object} context - The context object containing pagination details.
       * @param {string} context['current-page'] - The current page number (1-based).
       * @param {string} context['total-pages'] - The total number of pages.
       * @param {string} context['base-url'] - The explicit URL for Page 1 (e.g., '/blog.html').
       * @param {string} context['url-prefix'] - The directory prefix for paginated segments (e.g., '/blog').
       * @param {string} [context.segment='page'] - The URL segment for pagination (default: 'page').
       * @param {string} [context.max-visible='5'] - Max number of direct page links to show.
       * @param {string} [context.ellipsis='...'] - Text to display for skipped pages.
       * @returns {string} - A string containing the HTML <li> elements.
       */
      paginationLinks(context) {
        // Parse inputs with defaults
        const currentPage = parseInt(context['current-page'] || '1', 10)
        const totalPages = parseInt(context['total-pages'] || '1', 10)
        const maxVisible = parseInt(context['max-visible'] || '5', 10)
        
        const baseUrl = context['base-url'] || ''
        const urlPrefix = context['url-prefix'] || ''
        const segment = context['segment'] || 'page'
        const ellipsis = context['ellipsis'] || '...'

        /**
         * Constructs the URL for a specific page.
         * 1. Page 1 links strictly to `base-url` (canonical root).
         * 2. Pages > 1 follow the pattern: `{url-prefix}/{segment}/{page}.html`.
         */
        const getPageUrl = (page) => {
          if (page === 1) {
            return baseUrl
          }
          
          // Ensure prefix has a trailing slash for concatenation
          const cleanPrefix = urlPrefix.endsWith('/') ? urlPrefix : `${urlPrefix}/`
          return `${cleanPrefix}${segment}/${page}.html`
        }

        // Helper to generate list items
        const createItem = (page, text, isActive, isDisabled) => {
          let className = 'page-item'
          if (isActive) className += ' active'
          if (isDisabled) className += ' disabled'

          let attr = ''
          if (isActive) attr += ' aria-current="page"'
          if (isDisabled) attr += ' tabindex="-1" aria-disabled="true"'

          const href = isDisabled ? '#' : getPageUrl(page)

          return `<li class="${className}"><a class="page-link" href="${href}"${attr}>${text}</a></li>`
        }

        let links = ''

        // Previous Link
        links += createItem(currentPage - 1, 'Previous', false, currentPage <= 1)

        // Calculate Window (Start/End)
        const half = Math.floor(maxVisible / 2)
        let start = currentPage - half
        let end = currentPage + half

        if (start < 1) {
          start = 1
          end = Math.min(totalPages, maxVisible)
        }

        if (end > totalPages) {
          end = totalPages
          start = Math.max(1, totalPages - maxVisible + 1)
        }

        // Render Pages with ellipsis
        const showFirst = start > 1
        const showLast = end < totalPages

        // First page + ellipsis if window doesn't touch start
        if (showFirst) {
          links += createItem(1, '1', false, false)
          if (start > 2) {
            links += `<li class="page-item disabled"><span class="page-link">${ellipsis}</span></li>`
          }
        }

        // Main window loop
        for (let i = start; i <= end; i++) {
          links += createItem(i, i, i === currentPage, false)
        }

        // Last page + ellipsis if window doesn't touch end
        if (showLast) {
          if (end < totalPages - 1) {
            links += `<li class="page-item disabled"><span class="page-link">${ellipsis}</span></li>`
          }
          links += createItem(totalPages, totalPages, false, false)
        }

        // Next Link
        links += createItem(currentPage + 1, 'Next', false, currentPage >= totalPages)

        return links
      }
    }
  })
</script>
