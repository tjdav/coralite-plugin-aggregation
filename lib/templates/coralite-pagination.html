<template id="coralite-pagination">
  {{ paginationList }}
</template>

<script type="module">
  import { defineComponent } from 'coralite'

  export default defineComponent({
    tokens: {
      paginationList(values) {
        const length = parseInt(values.paginationLength)

        if (!length) return ''

        const maxVisible = parseInt(values.paginationMaxVisible)
        const currentPage = parseInt(values.paginationCurrent)
        const segment = values.paginationSegment
        const indexUrl = values.paginationIndexURLPathname
        const isIndexPage = values.$filePathname === values.paginationIndexPathname
        let baseDir = values.$urlDirname

        if (!isIndexPage) {
          baseDir = values.$urlDirname.replace(`/${segment}`, '')
        } else if (!values.$urlPathname.endsWith('index.html')) {
          // use filename as a directory
          baseDir = '/' + values.$filename.replace('.html', '')
        }

        if (baseDir === '/') {
          baseDir = ''
        }

        const getPageUrl = (page) => {
          if (page === 1) {
            return indexUrl
          }
          return `${baseDir}/${segment}/${page}.html`
        }

        const pages = []
        if (maxVisible >= length) {
          for (let i = 1; i <= length; i++) pages.push(i)
        } else {
          // Center the active page
          let start = currentPage - Math.floor(maxVisible / 2)
          start = Math.max(1, start)
          let end = start + maxVisible - 1

          // Shift window if we hit the end bound
          if (end > length) {
            end = length
            start = Math.max(1, end - maxVisible + 1)
          }

          if (start > 1) {
            pages.push(1)
            if (start > 2) pages.push('...')
          }

          for (let i = start; i <= end; i++) {
            pages.push(i)
          }

          if (end < length) {
            if (end < length - 1) pages.push('...')
            pages.push(length)
          }
        }

        const buildItem = (label, pageNum, isDisabled = false, isActive = false) => {
          if (isDisabled) {
            return `<li class="page-item disabled"><span class="page-link">${label}</span></li>`
          }
          const activeClass = isActive ? ' active' : ''
          const aria = isActive ? ' aria-current="page"' : ''
          return `<li class="page-item${activeClass}"><a class="page-link"${aria} href="${getPageUrl(pageNum)}">${label}</a></li>`
        }

        let html = '<ul class="pagination">'

        // Previous
        html += buildItem('Previous', currentPage - 1, currentPage <= 1)

        // Numbered items
        pages.forEach(page => {
          if (page === '...') {
            html += buildItem('...', null, true)
          } else {
            html += buildItem(page, page, false, page === currentPage)
          }
        })

        // Next
        html += buildItem('Next', currentPage + 1, currentPage >= length)

        html += '</ul>'

        return html
      }
    }
  })
</script>