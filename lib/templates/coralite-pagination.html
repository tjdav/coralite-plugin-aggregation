<template id="coralite-pagination">
  {{ paginationList }}
</template>

<script type="module">
  import { defineComponent } from 'coralite'

  export default defineComponent({
    tokens: {
      paginationList (values) {
        const length = parseInt(values.paginationLength)

        // skip pagination if not needed
        if (!length) {
          return ''
        }

        let dirname = values.paginationURLDirname

        // remove trailing slash if present (but not for root directory)
        if (dirname === '/' || dirname.endsWith('/')) {
          dirname = dirname.slice(0, -1);
        }

        const maxVisible = parseInt(values.paginationMaxVisible)
        const currentPage = parseInt(values.paginationCurrent)
        const indexURLPathname = values.paginationIndexURLPathname
        const segment = values.paginationSegment
        const pages = []

        if (maxVisible >= length) {
          // show all pages when max visible is greater than or equal to total page count
          for (let i = 1; i <= length; i++) {
            pages.push(i)
          }
        } else {
          // calculate start and end of visible range based on current page position
          let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
          let end = Math.min(length, start + maxVisible - 1);

          if (start > 1) {
            pages.push(1)

            if (start > 2) {
              // add ellipsis to indicate omitted pages before visible range
              pages.push('...')
            }
          }

          for (let i = start; i <= end; i++) {
            pages.push(i)
          }

          if (end < length) {
            if (length - end > 1) {
              // add ellipsis to indicate omitted pages after visible range
              pages.push('...')
            }

            pages.push(length)
          }
        }


        let attributes = 'class="page-link"'
 
        // highlight current page if it matches the document path
        if (values.paginationFilePathname === values.$filePathname) {
          attributes = 'class="page-link active" aria-current="page"'
        }

        // add first page link
        let items = `<li class="page-item"><a ${attributes} href="${indexURLPathname}">1</a></li>`

        // generate page items
        for (let i = 1; i < pages.length; i++) {
          const pageNum = pages[i]
          
          // check if current item an ellipsis
          if (pageNum === '...') {
            items += `<li class="page-item disabled"><span class="page-link">${pageNum}</span></li>`
          } else {
            // determine if this page number matches the current page
            const isCurrent = currentPage === pageNum

            let attributes = 'class="page-link"'

            if (isCurrent) {
              // add active state for current page
              attributes = 'class="page-link active" aria-current="page"'
            }

            let href = `${dirname}/${segment}/${pageNum}.html`

            if (values.paginationIndexPathname !== values.$filePathname) {
              href = `${dirname}/${pageNum}.html`
            } 

            // construct link with dynamic page number and base directory path
            items += `<li class="page-item"><a ${attributes} href="${href}">${pageNum}</a></li>`
          }
        }

        let nextItem = '<li class="page-item disabled"><span class="page-link">Next</span></li>'
        let prevItem = '<li class="page-item disabled"><span class="page-link">Previous</span></li>'


        // initialize previous/next items as disabled links
        if (currentPage > 1) {
          let href = `${dirname}/${currentPage - 1}.html`

          if (currentPage === 2) {
            // set index path
            href = indexURLPathname
          }

          prevItem = `<li class="page-item"><a class="page-link" href="${href}">Previous</a></li>`;
        }

        if (currentPage < length) {
          const pageNum = currentPage + 1
          let href = `${dirname}/${segment}/${pageNum}.html`

          if (values.paginationIndexPathname !== values.$filePathname) {
            href = `${dirname}/${pageNum}.html`
          } 

          nextItem = `<li class="page-item"><a class="page-link" href="${href}">Next</a></li>`;
        }

        return '<ul class="pagination">' + prevItem + items + nextItem + '</ul>'
      }
    }
  })
</script>